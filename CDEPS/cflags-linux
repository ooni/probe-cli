# Sets CFLAGS for Linux

#
# The rationale here is that enabling warnings is not going to benefit us
# because we're not developers of these libraries. So, enabling warnings is
# only going to be painful because we see lots of pain points. That said,
# we can still get some benefits by using the other hardening flags. It is
# also worth mentioning that we should not be linking directly because it
# is up to Go to do that. But, it still won't hurt to use the right LDFLAGS.
#
# See https://airbus-seclab.github.io/c-compiler-security/
#

CFLAGS="${CFLAGS:-} -O2"
#CFLAGS="${CFLAGS} -Werror" # prevents zlib from compiling ðŸ™„
#CFLAGS="${CFLAGS} -Wall -Wextra -Wpedantic -Wformat=2 -Wformat-overflow=2 -Wformat-truncation=2 -Wformat-security -Wnull-dereference -Wstack-protector -Wtrampolines -Walloca -Wvla -Warray-bounds=2 -Wimplicit-fallthrough=3 -Wtraditional-conversion -Wshift-overflow=2 -Wcast-qual -Wstringop-overflow=4 -Wconversion -Warith-conversion -Wlogical-op -Wduplicated-cond -Wduplicated-branches -Wformat-signedness -Wshadow -Wstrict-overflow=4 -Wundef -Wstrict-prototypes -Wswitch-default -Wswitch-enum -Wstack-usage=1000000 -Wcast-align=strict"
CFLAGS="${CFLAGS} -D_FORTIFY_SOURCE=3"
CFLAGS="${CFLAGS} -fstack-protector-strong -fstack-clash-protection -fPIE"
CFLAGS="${CFLAGS} -fsanitize=bounds -fsanitize-undefined-trap-on-error"
export CFLAGS

export LDFLAGS="${LDFLAGS:-} -Wl,-z,relro -Wl,-z,now -Wl,-z,noexecstack -Wl,-z,separate-code"
