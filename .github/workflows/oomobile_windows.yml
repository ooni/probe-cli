name: Setup Custom Gomobile

on:
  push:
    branches:
      - test/oomobile
  workflow_dispatch:

jobs:
  setup-gomobile:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'  # Adjust as needed

      - name: Install custom gomobile
        run: |
          go install go install github.com/ooni/oomobile/cmd/gomobile@v0.1.4
          go install go install github.com/ooni/oomobile/cmd/gobind@v0.1.4
          go get github.com/ooni/oomobile@v0.1.4

      - name: Add Go bin to PATH
        run: echo "$env:USERPROFILE\go\bin" | Out-File -Append -Encoding ascii $env:GITHUB_PATH

      - name: Run gomobile init
        run: |
          $env:Path += ";$env:USERPROFILE\go\bin"
          gomobile init -v

      - name: Run gomobile bind
        run:  |
          $env:Path += ";$env:USERPROFILE\go\bin"
          gomobile bind -target=java -o oonimkall.jar ./pkg/oonimkall
